<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TableTalk CSV Agent</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a1a;
            color: #f1f1f1;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 flex flex-col items-center justify-center min-h-screen p-4">

    <!-- Main Container -->
    <div class="bg-gray-800 p-8 rounded-xl shadow-lg w-full max-w-2xl flex flex-col space-y-6">
        <h1 class="text-3xl font-bold text-center text-indigo-400">TableTalk CSV Agent</h1>
        <p class="text-center text-gray-400">Upload your CSV file and ask questions about your data with AI-powered analysis.</p>

        <!-- File Upload Section -->
        <div class="bg-gray-700 p-4 rounded-lg border border-gray-600">
            <h3 class="text-lg font-semibold text-green-400 mb-3">üìÅ Upload CSV File</h3>
            <div class="flex items-center space-x-4">
                <input
                    type="file"
                    id="csvFileInput"
                    accept=".csv"
                    class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-indigo-600 file:text-white hover:file:bg-indigo-700 file:cursor-pointer"
                />
                <button
                    id="uploadButton"
                    class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-200 transform active:scale-95 disabled:bg-green-400"
                >
                    Upload
                </button>
            </div>
            <div id="fileInfo" class="mt-3 text-sm text-gray-300 hidden">
                <p id="fileDetails"></p>
            </div>
            <div id="uploadStatus" class="mt-2 text-sm hidden"></div>
        </div>

        <!-- Large Input Area -->
        <div class="w-full">
            <textarea
                id="promptInput"
                rows="6"
                placeholder="e.g., How many students are there in the dataset? What's the age distribution? Which city has the most students?

You can ask complex questions and the agent will analyze the CSV data to provide detailed answers."
                class="w-full p-4 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:border-indigo-500 transition-colors placeholder-gray-400 resize-none min-h-[150px]"
            ></textarea>
        </div>

        <!-- Stream Mode Toggle -->
        <div class="flex items-center space-x-3">
            <label class="flex items-center space-x-2 cursor-pointer">
                <input
                    type="checkbox"
                    id="streamToggle"
                    checked
                    class="w-4 h-4 text-green-600 bg-gray-700 border-gray-600 rounded focus:ring-green-500 focus:ring-2"
                />
                <span class="text-sm text-gray-300">Stream thinking process (show agent's reasoning in real-time)</span>
            </label>
        </div>

        <!-- Action Buttons -->
        <div class="flex space-x-4 w-full">
            <button
                id="askButton"
                class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-200 transform active:scale-95 disabled:bg-indigo-400"
            >
                Ask Agent
            </button>
            <button
                id="clearButton"
                class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-all duration-200 transform active:scale-95"
            >
                Clear
            </button>
        </div>

        <!-- Timeout and Abort Controls -->
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-2">
                <label class="text-sm text-gray-400">Timeout:</label>
                <select id="timeoutSelect" class="bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm">
                    <option value="60">1 minute</option>
                    <option value="120">2 minutes</option>
                    <option value="300" selected>5 minutes</option>
                    <option value="600">10 minutes</option>
                    <option value="0">No Timeout</option>
                </select>
            </div>
            <div id="abortSection" class="hidden flex items-center space-x-2">
                <div id="countdown" class="text-sm text-yellow-400"></div>
                <button id="abortButton" class="bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded text-sm">
                    Abort
                </button>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loading" class="text-center hidden">
            <div class="flex items-center justify-center space-x-2">
                <div class="w-4 h-4 rounded-full bg-indigo-500 animate-bounce"></div>
                <div class="w-4 h-4 rounded-full bg-indigo-500 animate-bounce delay-150"></div>
                <div class="w-4 h-4 rounded-full bg-indigo-500 animate-bounce delay-300"></div>
            </div>
            <p class="mt-2 text-sm text-gray-400">Processing...</p>
        </div>

        <!-- Streaming Thinking Process -->
        <div id="thinkingContainer" class="bg-gray-700 p-4 rounded-lg border border-gray-600 hidden max-h-[300px] overflow-y-auto">
            <h3 class="text-lg font-semibold text-yellow-400 mb-2">Agent's Thinking Process:</h3>
            <div id="thinkingOutput" class="font-mono text-sm space-y-1"></div>
        </div>
        
        <!-- Response Area -->
        <div id="responseContainer" class="bg-gray-700 p-6 rounded-lg border border-gray-600 mt-6 min-h-[100px] max-h-[400px] overflow-y-auto">
            <p id="responseOutput" class="whitespace-pre-wrap"></p>
        </div>

        <!-- Server Status -->
        <div class="flex items-center justify-center space-x-2 mt-4">
            <div id="serverStatus" class="flex items-center space-x-2">
                <div id="statusDot" class="w-3 h-3 rounded-full bg-green-400"></div>
                <span id="statusText" class="text-sm text-green-400">Server Online</span>
            </div>
        </div>

        <!-- Environment Variable Warning -->
        <div class="text-center text-red-400 mt-2 text-xs">
            <p>Ensure `GROQ_API_KEY` is set as an environment variable on your backend server.</p>
        </div>
    </div>

    <script>
        const promptInput = document.getElementById('promptInput');
        const askButton = document.getElementById('askButton');
        const clearButton = document.getElementById('clearButton');
        const streamToggle = document.getElementById('streamToggle');
        const loadingDiv = document.getElementById('loading');
        const responseOutput = document.getElementById('responseOutput');
        const thinkingContainer = document.getElementById('thinkingContainer');
        const thinkingOutput = document.getElementById('thinkingOutput');
        const timeoutSelect = document.getElementById('timeoutSelect');
        const abortSection = document.getElementById('abortSection');
        const abortButton = document.getElementById('abortButton');
        const countdown = document.getElementById('countdown');
        
        // File upload elements
        const csvFileInput = document.getElementById('csvFileInput');
        const uploadButton = document.getElementById('uploadButton');
        const fileInfo = document.getElementById('fileInfo');
        const fileDetails = document.getElementById('fileDetails');
        const uploadStatus = document.getElementById('uploadStatus');
        
        // Server status elements
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        
        let currentEventSource = null;
        let currentRequestId = null;
        let countdownInterval = null;
        let isFileUploaded = false;
        let serverHealthInterval = null;
        let lastServerCheck = Date.now();
        
        // Function to make standard API call
        async function askAgent() {
            const prompt = promptInput.value.trim();
            if (!prompt) return;

            const timeout = parseInt(timeoutSelect.value);
            
            // Reset UI
            resetUI();
            showLoading();

            try {
                const response = await fetch('http://localhost:8000/ask', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        prompt: prompt,
                        timeout: timeout
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const data = await response.json();
                responseOutput.textContent = data.response;

            } catch (error) {
                console.error('Error fetching data:', error);
                updateServerStatus(false);
                responseOutput.textContent = `Error: ${error.message}. Server may have crashed - please refresh the page.`;
            } finally {
                hideLoading();
            }
        }
        
        // Function to make streaming API call
        async function askAgentStream() {
            const prompt = promptInput.value.trim();
            if (!prompt) return;

            const timeout = parseInt(timeoutSelect.value);
            
            // Reset UI
            resetUI();
            showLoading();
            thinkingContainer.classList.remove('hidden');
            
            // Start countdown
            startCountdown(timeout);
            
            try {
                const params = new URLSearchParams({
                    prompt: prompt,
                    timeout: timeout.toString()
                });
                currentEventSource = new EventSource(`http://localhost:8000/ask-stream?${params}`);
                
                currentEventSource.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    currentRequestId = data.request_id;
                    
                    switch(data.type) {
                        case 'start':
                            addThinkingMessage(data.message, 'text-blue-400');
                            break;
                        case 'thinking':
                            addThinkingMessage(data.message, 'text-gray-300');
                            break;
                        case 'result':
                            responseOutput.textContent = data.message;
                            addThinkingMessage('‚úì Final Answer: ' + data.message, 'text-green-400');
                            endStream();
                            break;
                        case 'error':
                            responseOutput.textContent = `Error: ${data.message}`;
                            addThinkingMessage('‚úó Error: ' + data.message, 'text-red-400');
                            endStream();
                            break;
                        case 'timeout':
                            responseOutput.textContent = data.message;
                            addThinkingMessage('‚è± ' + data.message, 'text-yellow-400');
                            endStream();
                            break;
                        case 'aborted':
                            responseOutput.textContent = data.message;
                            addThinkingMessage('‚èπ ' + data.message, 'text-orange-400');
                            endStream();
                            break;
                        case 'end':
                            endStream();
                            break;
                    }
                };
                
                currentEventSource.onerror = function(event) {
                    console.error('EventSource failed:', event);
                    updateServerStatus(false);
                    responseOutput.textContent = 'Connection error. Server may have crashed - please refresh the page.';
                    endStream();
                };
                
            } catch (error) {
                console.error('Error setting up stream:', error);
                responseOutput.textContent = `Error: ${error.message}`;
                endStream();
            }
        }
        
        // Function to abort current request
        async function abortRequest() {
            if (currentRequestId) {
                try {
                    await fetch(`http://localhost:8000/abort/${currentRequestId}`, {
                        method: 'POST'
                    });
                } catch (error) {
                    console.error('Error aborting request:', error);
                }
            }
            endStream();
        }
        
        // Helper functions
        function resetUI() {
            responseOutput.textContent = '';
            thinkingOutput.innerHTML = '';
            thinkingContainer.classList.add('hidden');
            abortSection.classList.add('hidden');
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
        }
        
        function showLoading() {
            askButton.disabled = true;
            loadingDiv.classList.remove('hidden');
        }
        
        function hideLoading() {
            askButton.disabled = false;
            loadingDiv.classList.add('hidden');
        }
        
        function clearAll() {
            promptInput.value = '';
            resetUI();
        }
        
        function handleAskAgent() {
            if (!isFileUploaded) {
                showUploadError("Please upload a CSV file first before asking questions.");
                return;
            }
            
            if (streamToggle.checked) {
                askAgentStream();
            } else {
                askAgent();
            }
        }
        
        // File upload functionality
        async function uploadFile() {
            const file = csvFileInput.files[0];
            if (!file) {
                showUploadError("Please select a CSV file to upload.");
                return;
            }
            
            if (!file.name.endsWith('.csv')) {
                showUploadError("Please select a valid CSV file.");
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            uploadButton.disabled = true;
            uploadButton.textContent = 'Uploading...';
            showUploadStatus("Uploading and processing CSV file...", "text-blue-400");
            
            try {
                const response = await fetch('http://localhost:8000/upload', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Upload failed');
                }
                
                const data = await response.json();
                
                // Show success
                showUploadStatus(`‚úÖ ${data.message}`, "text-green-400");
                showFileInfo(data);
                isFileUploaded = true;
                
                // Update UI state
                askButton.disabled = false;
                promptInput.disabled = false;
                
            } catch (error) {
                console.error('Upload error:', error);
                if (error.message.includes('fetch')) {
                    updateServerStatus(false);
                }
                showUploadError(`Upload failed: ${error.message}`);
                isFileUploaded = false;
            } finally {
                uploadButton.disabled = false;
                uploadButton.textContent = 'Upload';
            }
        }
        
        function showFileInfo(data) {
            fileDetails.textContent = `üìä ${data.filename} ‚Ä¢ ${data.rows} rows ‚Ä¢ ${data.columns.length} columns`;
            fileInfo.classList.remove('hidden');
        }
        
        function showUploadStatus(message, colorClass) {
            uploadStatus.textContent = message;
            uploadStatus.className = `mt-2 text-sm ${colorClass}`;
            uploadStatus.classList.remove('hidden');
        }
        
        function showUploadError(message) {
            showUploadStatus(`‚ùå ${message}`, "text-red-400");
        }
        
        // Check if file is already loaded on page load
        async function checkFileStatus() {
            try {
                const response = await fetch('http://localhost:8000/data-info');
                const data = await response.json();
                
                // Server is responsive
                updateServerStatus(true);
                
                if (!data.error) {
                    showFileInfo(data);
                    isFileUploaded = true;
                    askButton.disabled = false;
                    promptInput.disabled = false;
                    showUploadStatus("‚úÖ CSV file is loaded and ready", "text-green-400");
                } else {
                    askButton.disabled = true;
                    promptInput.disabled = true;
                    showUploadStatus("üìÇ Please upload a CSV file to get started", "text-yellow-400");
                }
            } catch (error) {
                console.error('Error checking file status:', error);
                updateServerStatus(false);
                askButton.disabled = true;
                promptInput.disabled = true;
                showUploadStatus("‚ö†Ô∏è Server connection error", "text-red-400");
            }
        }
        
        // Server health monitoring
        async function checkServerHealth() {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 second timeout
                
                const response = await fetch('http://localhost:8000/api', {
                    method: 'GET',
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    updateServerStatus(true);
                    lastServerCheck = Date.now();
                } else {
                    updateServerStatus(false);
                }
            } catch (error) {
                console.error('Server health check failed:', error);
                updateServerStatus(false);
            }
        }
        
        function updateServerStatus(isOnline) {
            if (isOnline) {
                statusDot.className = 'w-3 h-3 rounded-full bg-green-400';
                statusText.textContent = 'Server Online';
                statusText.className = 'text-sm text-green-400';
            } else {
                statusDot.className = 'w-3 h-3 rounded-full bg-red-400';
                statusText.textContent = 'Server Offline - Please refresh page';
                statusText.className = 'text-sm text-red-400';
                
                // Show server crash message in response area
                if (responseOutput.textContent === '' || responseOutput.textContent === 'Processing...') {
                    responseOutput.textContent = 'üö® Server Connection Lost\n\nThe server appears to have crashed or is unresponsive. Please:\n\n1. Refresh the page\n2. Wait a moment for the server to restart\n3. Try your request again\n\nIf the problem persists, the server may need manual restart.';
                }
                
                // Disable interactions
                askButton.disabled = true;
                uploadButton.disabled = true;
            }
        }
        
        function startServerMonitoring() {
            // Check server health every 10 seconds
            serverHealthInterval = setInterval(checkServerHealth, 10000);
            
            // Initial check
            checkServerHealth();
        }
        
        function stopServerMonitoring() {
            if (serverHealthInterval) {
                clearInterval(serverHealthInterval);
                serverHealthInterval = null;
            }
        }
        
        function endStream() {
            hideLoading();
            abortSection.classList.add('hidden');
            if (currentEventSource) {
                currentEventSource.close();
                currentEventSource = null;
            }
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            currentRequestId = null;
        }
        
        function addThinkingMessage(message, colorClass) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `${colorClass} mb-1`;
            messageDiv.textContent = message;
            thinkingOutput.appendChild(messageDiv);
            thinkingContainer.scrollTop = thinkingContainer.scrollHeight;
        }
        
        function startCountdown(totalSeconds) {
            abortSection.classList.remove('hidden');
            
            if (totalSeconds === 0) {
                countdown.textContent = 'No Timeout';
                return;
            }
            
            let remaining = totalSeconds;
            
            countdownInterval = setInterval(() => {
                const minutes = Math.floor(remaining / 60);
                const seconds = remaining % 60;
                countdown.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                if (remaining <= 0) {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                }
                remaining--;
            }, 1000);
        }

        // Add event listeners
        askButton.addEventListener('click', handleAskAgent);
        clearButton.addEventListener('click', clearAll);
        abortButton.addEventListener('click', abortRequest);
        uploadButton.addEventListener('click', uploadFile);

        promptInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                handleAskAgent();
            }
        });
        
        // File input change listener
        csvFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                uploadStatus.classList.add('hidden');
            }
        });
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            checkFileStatus();
            startServerMonitoring();
        });
        
        // Check file status on page load
        checkFileStatus();
        
        // Start server monitoring
        startServerMonitoring();
        
        // Cleanup when page unloads
        window.addEventListener('beforeunload', () => {
            stopServerMonitoring();
        });
    </script>
</body>
</html>
